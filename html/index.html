<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>DualTZ config</title>

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.css" />
    <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.js"></script>
    <script src="http://tzdata-javascript.org/tzdata-javascript.js"></script>
  </head>
  <body>
    <!-- Home -->
    <div data-theme="c" data-role="page" id="page1">
      <div data-theme="c" data-role="header">
        <h3>DualTZ config</h3>
	<a href="#help" data-icon="info" data-transition="slide" class="ui-btn-right">Help</a>
      </div>
      <div data-theme="c" data-role="content">
	<div class="ui-grid-a">
	  <div class="ui-block-a">
	    <label for="detect-remote-button" class="ui-hidden-accessible">Detect position</label>
	    <a data-role="button" href="#settings" data-icon="home" data-iconpos="left" id="detect-remote-button">Detect</a>
	  </div>
	  <div class="ui-block-b">
	    <label for="utc-button" class="ui-hidden-accessible">Use UTC time</label>
	    <a data-role="button" href="#settings" id="utc-button">Use UTC</a>
	  </div>
	</div>
	<input type="hidden" name="remote-tz-location" id="remote-tz-location" value="">
	<label for="remote-tz-name" data-inline="true">Location name</label>
	<input type="text" data-clear-btn="true" name="remote-tz-name" data-inline="true" id="remote-tz-name" maxlength="15" value="">
        <div class="ui-grid-a">
          <div class="ui-block-a">
            <a data-role="button" href="#settings" data-icon="delete" data-iconpos="left" id="b-cancel">Cancel</a>
          </div>
          <div class="ui-block-b">
            <a data-role="button" href="#settings" data-icon="check" data-iconpos="left" id="b-submit">Submit</a>
          </div>
        </div>
      </div>
    </div>
    <div data-theme="c" data-role="page" id="help" data-add-back-btn="true">
      <div data-theme="c" data-role="header">
	<h3>DualTZ help</h3>
      </div>
      <h3>Configuration</h3>
      <p>To configure the timezone to display, you can:
      <ul>
	<li>Select a region from the map.</li>
	<li>Hit the Detect button to select your current location.</li>
	<li>Hit the UTC button to select UTC.</li>
      </ul>
      <p>Once selected, the location name field will be filled with a large
	city in the region selected. If desired, this name can be altered,
	to match a smaller town in the region for example. The maximum length
        for the name field is 15 characters.
      </p>
      <p>Finally, hit the Submit button to send the new details to the watch
	app, or Cancel to quit without saving new zone.</p>
      <h3>Usage</h3>
      <p>The analogue face shows the time and date in the current time zone.
	The digital portion will show the time in the configured time zone.</p>
      <p>When the watch face starts running, it will attempt to fetch the
	current time zone from its paired phone. If this fails (the phone
	is switched off, for example), then it will fall back on the time
	zone that was last retrieved from the phone.</p>
      <p>In case of failure, ensure your phone is set to the correct time
	zone, and then restart the watch app by entering the menu and
	exiting again.</p>
    </div>
    <script>
      tzdata_javascript.settings.baseURL = 'http://hardy.dropbear.id.au/DualTZ/config/zoneinfo/';

      var remote_offset = null;
      var query_in_progress = 0;
      var query_timezone = '';

      $().ready(function () {

        function requestTimeout() {
          if (query_in_progress > 0) {
            console.log('TZ request timeout: ' + query_timezone);
            // TODO: better notification
            $('#b-submit .ui-btn-text').text('TZ timeout');
            window.clear_timeout(query_in_progress);
            query_in_progress = 0;
          }
        }

        function tzCallback(timezone, zoneinfo) {
          console.log('Got TZ info: ' + timezone);
          if (query_in_progress > 0 && timezone === query_timezone) {
            var now = new Date();
            remote_offset = zoneinfo.localtime(now).ttinfo.offset/1000;
            console.log('Remote TZ: ' + remote_offset);
            query_in_progress = 0;
            $('#b-submit .ui-btn-text').text('Submit');
            $('#b-submit').removeClass('ui-disabled');
          }
        }

        function updateZone(name) {
          console.log('Requesting TZ info: ' + name);
          var city = name.split('/').pop().replace('_', ' ');
          $('#remote-tz-name').val(city);
          if (query_in_progress > 0) {
            window.clearTimeout(query_in_progress);
            query_in_progress = 0;
          }
          query_timezone = name;
          query_in_progress = window.setTimeout(requestTimeout, 10000);
          $('#b-submit').addClass('ui-disabled');
          $('#b-submit .ui-btn-text').text('Fetching data...');
          new tzdata_javascript.zoneinfo(name, tzCallback);
        }

        function saveParams() {
          var now = new Date();
          // Wow, getTimezoneOffset() is the weirdest thing ever.
          var localtzoffset = now.getTimezoneOffset() * -60;
          var params = {
            'remote-tz-name': $('#remote-tz-name').val(),
            'remote-tz-offset': remote_offset,
            'local-tz-offset': localtzoffset
          }
          return params;
        }

        $('#utc-button').click(function() {
          console.log('UTC selected');
          // Update #remote-tz-name and #remote-location-name
          $('#remote-tz-location').val('UTC');
          $('#remote-tz-name').val('UTC');
          remote_offset = 0;
        });

        // Changes performed by JS don't trigger .change(),
        // so bind to clicks on the imagemap.
        $('#timezone-map area').click(function() {
          updateZone($('#remote-tz-location').val());
        });

        $('#b-cancel').click(function() {
          console.log('Cancel');
          document.location = 'pebblejs://close#';
        });

        $('#b-submit').click(function() {
          var params = saveParams();
          console.log(params['local-tz-offset']);
          var location = 'pebblejs://close#' + encodeURIComponent(JSON.stringify(params));
          console.log('Submit: '+location);
          document.location = location;
        });
      });
    </script>
  </body>
</html>
